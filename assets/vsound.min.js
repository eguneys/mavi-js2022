var VSound=function(){"use strict";function e(e,t,n,i){return{a:e,d:t,s:n,r:i}}const t=[1,1.5,2,2.5,3,4,4.5,5,5.5,6,6.5,7];function n(e){let n=function(e){return(240&e)>>4}(e),i=function(e){return 15&e}(e),a=function(e){return(61440&e)>>12}(e);1===a&&(i+=.5);let r=t.indexOf(i);return r+=12*n,440*Math.pow(2,(r-57)/12)}function i(e,t,{a:n,d:i,s:a,r:r},s,l){n/=1e3,i/=1e3,e.setValueAtTime(s,t),e.linearRampToValueAtTime(l,t+n),e.linearRampToValueAtTime(a,t+n+i)}function a(e,t,{r:n},i){n/=1e3,e.cancelScheduledValues(t),e.linearRampToValueAtTime(i,t+(n||0))}class r{get context(){return this._context||(this._context=new AudioContext),this._context}get currentTime(){return this.context.currentTime}_gen_id=0;get next_id(){return++this._gen_id}players=new Map;attack(e,t,i=0){let{next_id:a}=this;return this.players.set(a,new l(this.context)._set_data({synth:e,freq:n(t)}).attack(i)),a}release(e,t=0){let n=this.players.get(e);n&&n.release(t),this.players.delete(e)}}function s(e,t){return new OscillatorNode(e,{type:t})}class l extends class{get maxFilterFreq(){return this.context.sampleRate/2}constructor(e){this.context=e}attack(e=this.context.currentTime){let{context:t}=this;return this.gain=t.createGain(),this.gain.gain.setValueAtTime(1,e),this.gain.connect(t.destination),this._attack(e),this}release(e=this.context.currentTime){return this._release(e),this}}{_set_data(e){return this.data=e,this}_attack(e){let{context:t,maxFilterFreq:n}=this,a=this.gain,{freq:r,synth:l}=this.data,{wave:c,volume:u,cutoff:o,cutoff_max:h,amplitude:f,filter_adsr:d,amp_adsr:m}=l,p=s(t,c);this.osc1=p;let _=s(t,c);this.osc2=_;let g=new GainNode(t);p.connect(g);let x=new GainNode(t);_.connect(x),g.gain.setValueAtTime(.5,e),x.gain.setValueAtTime(.5,e),_.detune.setValueAtTime(700,e);let T=new BiquadFilterNode(t,{type:"lowpass"});this.filter=T,g.connect(T),x.connect(T),a.gain.setValueAtTime(u,e);let y=new GainNode(t);this.envelope=y,T.connect(y),y.connect(a),p.frequency.setValueAtTime(r,e),_.frequency.setValueAtTime(r,e);let w={...d,s:o*n*.4+d.s*h*n*.6};i(T.frequency,e,w,o*n*.4,o*n*.4+h*n*.6),i(y.gain,e,m,0,.5*f),p.start(e),_.start(e)}_release(e){let{synth:{cutoff:t,amp_adsr:n,filter_adsr:i}}=this.data,{a:r,d:s,r:l}=n;r/=1e3,s/=1e3,l/=1e3,a(this.envelope.gain,e,n,0),a(this.filter.frequency,e,i,t*this.maxFilterFreq*.4),this.osc1.stop(e+r+s+l),this.osc2.stop(e+r+s+l)}}const c=["sine","sawtooth","triangle","square"];function u(e){return[c[15&e],(240&e)>>4,(3840&e)>>8]}function o(e,t){return e.every(((e,n)=>0===n||e===t[n]))}return function(t){let n=new r;return t=t.map((t=>{let[n,...i]=t,a=[];for(let t=0;t<i.length;t+=2){let n=i[t],[r,s,l]=u(i[t+1]),c={wave:r,volume:l/5,amplitude:.9,cutoff:.6,cutoff_max:.2,amp_adsr:e(2,8,.2,10),filter_adsr:e(0,8,.2,0)};a.push([c,n,r,s,l])}return[n,a]})),e=>{let[i,a]=t[e],r=n.currentTime,s=[];for(let e=0;e<a.length;e++){let t=16*i/1e3;if(s.includes(e)){r+=t;continue}let l=a[e],c=[[e+1,e+2,e+3],[e+1,e+2],[e+1]].map((e=>e.filter((e=>e<a.length)).map((e=>a[e])))),u=1;3===c[0].length&&c[0].every((e=>o(l,e)))?(u=4,s=[e+1,e+2,e+3]):2===c[1].length&&c[1].every((e=>o(l,e)))?(u=3,s=[e+1,e+2]):1===c[2].length&&c[2].every((e=>o(l,e)))?(u=2,s=[e+1]):s=[],t*=u;let h=l[0],f=l[1],d=n.attack(h,f,r);n.release(d,r+t),r+=t}}}}();

